name: IntelliPerf Tests with Apptainer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  build-apptainer-image:
    runs-on: [self-hosted]
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Apptainer
        run: |
          apt-get update && apt-get install -y software-properties-common
          add-apt-repository -y ppa:apptainer/ppa
          apt-get update && apt-get install -y apptainer

      - name: Build IntelliPerf Apptainer container
        run: |
          # Create persistent Apptainer directory
          mkdir -p ~/apptainer

          # Build Apptainer image from definition file (only if it doesn't exist)
          if [ ! -f ~/apptainer/intelliperf-dev.sif ]; then
            echo "Building new Apptainer image..."
            ./apptainer/build.sh --output ~/apptainer/intelliperf-dev.sif
          else
            echo "Using existing Apptainer image"
          fi
  run-tests:
    name: IntelliPerf Test
    needs: build-apptainer-image
    runs-on: [self-hosted]
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run IntelliPerf Tests
        env:
          LLM_GATEWAY_KEY: ${{ secrets.LLM_GATEWAY_KEY }}
        run: |
          apptainer exec ~/apptainer/intelliperf-dev.sif bash -c "
            set -e  # Exit on any error

            # Set environment variables
            export LLM_GATEWAY_KEY='${{ secrets.LLM_GATEWAY_KEY }}'
            export ROCM_PATH=/opt/rocm
            export PATH=\$ROCM_PATH/bin:\$PATH
            export LD_LIBRARY_PATH=\$ROCM_PATH/lib:\$LD_LIBRARY_PATH

            # Install IntelliPerf (PyTorch ROCm and tools are already installed in container)
            pip install -e .
            python3 scripts/install_tool.py --all

            # IntelliPerf is installed at /root/.local/bin
            export PATH=\$PATH:/root/.local/bin

            # Create results directory
            mkdir -p ~/intelliperf_results

            # Run the IntelliPerf examples
            ./.github/workflows/scripts/ci_tests.sh

            # Check test results for success
            ./.github/workflows/scripts/check_test_results.sh
          "

      - name: Upload test outputs as artifact
        if: always()
        run: |
          echo "ðŸ“¥ Collecting test outputs..."
          mkdir -p test_outputs
          
          # Copy test results from container to local directory
          cp -r ~/intelliperf_results/ ./test_outputs/ || echo "No results directory found"
          
          # Create tar artifact
          tar -czf intelliperf_test_outputs.tar.gz -C test_outputs .
          echo "âœ… Test outputs archived as intelliperf_test_outputs.tar.gz"

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: intelliperf-test-outputs
          path: intelliperf_test_outputs.tar.gz
          retention-days: 15

