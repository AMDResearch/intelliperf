Bootstrap: docker
From: ubuntu:22.04

%environment
    # Locale
    export LANG=en_US.UTF-8

    # ROCm globals
    export PATH=/opt/rocm/bin:$PATH
    export LD_LIBRARY_PATH=/opt/rocm/lib:$LD_LIBRARY_PATH
    export ROCM_PATH=/opt/rocm

%post
    # Set locale
    apt-get -y update
    apt-get install -y locales
    locale-gen en_US.UTF-8
    export LANG=en_US.UTF-8

    # Install dependencies
    apt-get -y update
    apt-get install -y software-properties-common
    apt-get upgrade -y
    apt-get install -y build-essential python3 python3-pip python3-setuptools python3-wheel git wget clang lld libzstd-dev libomp-dev vim libdwarf-dev
    apt-get install -y locales
    locale-gen en_US.UTF-8
    python3 -m pip install --upgrade pip
    python3 -m pip install 'cmake==3.22'

    # Install ROCm
    apt-get -y update
    wget https://repo.radeon.com/amdgpu-install/6.3.3/ubuntu/jammy/amdgpu-install_6.3.60303-1_all.deb
    apt-get -y install ./amdgpu-install_6.3.60303-1_all.deb
    apt-get -y update
    apt-get install -y rocm-dev rocm-llvm-dev rocm-hip-runtime-dev rocm-smi-lib rocminfo rocthrust-dev rocprofiler-compute rocblas rocm-gdb gdb tmux
    export PATH=/opt/rocm/bin:$PATH
    export LD_LIBRARY_PATH=/opt/rocm/lib:$LD_LIBRARY_PATH
    export ROCM_PATH=/opt/rocm

    # Install Triton
    cd /root
    export TRITON_HOME=/root
    git clone -v https://github.com/triton-lang/triton.git
    cd triton
    git checkout 6fa33ef1eecc97348d056688df84845db7d22507
    python3 -m pip install ninja wheel pybind11
    python3 -m pip install -e python

    # Install PyTorch ROCm
    python3 -m pip install --pre torch torchvision torchaudio --index-url https://download.pytorch.org/whl/nightly/rocm6.3