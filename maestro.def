Bootstrap: docker
From: ubuntu:22.04

%post

    # Install dependencies
    apt-get -y update
    apt-get install -y software-properties-common 
    apt-get upgrade -y 
    apt-get install -y build-essential python3 python3-pip git wget clang lld libzstd-dev libomp-dev
    python3 -m pip install --upgrade pip 
    python3 -m pip install 'cmake==3.22'

    # Install ROCm
    mkdir --parents --mode=0755 /etc/apt/keyrings
    wget --no-check-certificate https://repo.radeon.com/rocm/rocm.gpg.key -O - | \
        gpg --dearmor | tee /etc/apt/keyrings/rocm.gpg > /dev/null
    
    echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/6.3.2 jammy main" \
        | tee --append /etc/apt/sources.list.d/rocm.list
    
    printf "Package: *\nPin: release o=repo.radeon.com\nPin-Priority: 600\n" | tee /etc/apt/preferences.d/rocm-pin-600  
    
    apt-get -y update
    ROCM_VERSION=$(apt-cache search rocm-dev[0-9] | awk '{print $1}' | sed 's/rocm-dev//g')
    apt-get install -y rocm-dev6.3.2 rocm-llvm-dev6.3.2 rocm-hip-runtime-dev6.3.2 rocm-smi-lib6.3.2 rocminfo6.3.2

    # Install logduration
    export SSH_AUTH_SOCK={{ SSH_AUTH_SOCK }}
    cd /root
    git clone -v git@github.com:AARInternal/logduration.git
    cd logduration
    mkdir -p build &&
    cmake -DCMAKE_PREFIX_PATH=${ROCM_PATH} -DLLVM_INSTALL_DIR=/opt/rocm/llvm -DCMAKE_BUILD_TYPE=Release -DCMAKE_VERBOSE_MAKEFILE=ON -S . -B build &&
    cmake --build build --target install
